<!-- TO DELETE WHEN PAGE IS DONE -->
<script type="text/javascript" src="../js/jquery-3.6.4.min.js"></script>
<link rel = "stylesheet" href = "../css/style.css">

<!-- Blog style -->
<link rel = "stylesheet" href = "../css/blog.css">
<!-- Needed to use the "md-block" HTML item -->
<script type="module" src="https://md-block.verou.me/md-block.js"></script>

<h1 style="text-align: center;">Blogs</h1>

<div id="flex_container">
    <div>
        <button id="back">BACK</button>
        <ul id="file_list"></ul>
    </div>
    
    <md-block id="file_display" src="https://raw.githubusercontent.com/TheSevenSages/SageXR/refs/heads/main/DEVLOG/November%202025/11-19.md"></md-block>
</div>

<script>

    const blogs = [
        {
            name: 'SageXR',
            pathToBlog: "DEVLOG",
            tree: null,
            displayBlog: async function(){
                // Load blog tree
                if (!this.tree)
                {
                    this.tree = await GetGitHubTree("TheSevenSages", this.name, this.pathToBlog)
                    console.log(this.tree)
                }
                else { console.log(this.name + ' tree already loaded!')}

                DisplayBlogTree(this, "")
            },
            getFileSrc: function(path){
                // We can use 'this' here so long as 
                return GetGitHubRawFile("TheSevenSages", this.name, this.pathToBlog + '/' + path)
            }
        }
    ]

    const file_list = document.getElementById("file_list")
    const file_display = document.getElementById("file_display")

    ViewBlogs()

    // Returns the tree of the repo relative to the given subdirectory
    async function GetGitHubTree(owner, repo, subdir){
        const url = `https://api.github.com/repos/${owner}/${repo}/git/trees/main?recursive=1`

        try
        {
            const response = await fetch(url)
            if (!response.ok) { throw new Error('HTTP error! status ' + response.status) }

            const content = await response.json()

            // If no subdir is specified return the whole tree
            if (subdir == "") { return content.tree } 

            // Sanitize the subdir path (this prevents us from accidentally including files with the same name as the final node in our subdir)
            let prefix = subdir.endsWith('/') ? subdir : subdir + '/';
            // Remove all of the nodes that don't start with our subdirectory path
            const filteredTree = content.tree.filter(item => item.path.startsWith(prefix))

            // Remove the prefix from all of our paths to make them relative to the subdir
            // Also format the tree in a more generic way
            const formattedTree = () => {
                let _array= []
                filteredTree.forEach(element => {
                    _array.push({
                        path: element.path.substring(prefix.length),
                        type: element.type == "tree" ? "dir" : "file"
                    })
                });
                return _array
            }

            return formattedTree()
        }
        catch (error)
        {
            console.error(`Error fetching content from ${url}:`, error)
        }
    }

    // Gets the link to a file stored on GitHub's raw contents
    function GetGitHubRawFile(owner, repo, pathToFile){
        return `https://raw.githubusercontent.com/${owner}/${repo}/refs/heads/main/${pathToFile}`
    }

    // Displays all the nodes in the given blog's file tree at the specified path
    function DisplayBlogTree(blog, path){

        const directory = blog.tree
        // Only display the nodes that are at the same point in the tree as us
        const displayList = directory.filter(element => {
            // If the node is not in the current path at all, don't include it
            if (!element.path.includes(path)) { return false }
            // If the node DOES include the path but goes deeper in the tree than us don't include it
            if (element.path.substring(path.length + 1).includes('/')) { return false }
            return true
        })

        // Clear the existing list
        file_list.innerHTML = ''

        displayList.forEach(element => {
            let li = document.createElement('li')
            const name = element.path.substring(path.length + (path == "" ? 0 : 1))
            li.classList.add("link")
            li.innerText = name

            if (element.type == 'dir'){
                // When clicked show contents of this directory in file_list
                li.addEventListener("click", () => {
                    DisplayBlogTree(blog, element.path)
                })
            }
            else if (element.type == 'file'){
                // When clicked display contents of file on webpage (if markdown)
                const file_type = name.slice((name.lastIndexOf(".") - 1 >>> 0) + 2)
                if (file_type == "md"){
                    li.addEventListener("click", function(){
                        file_display.src = blog.getFileSrc(element.path)
                    })
                }
            }

            file_list.appendChild(li)
        });

        // Set the functionality of the back button according to the current path
        // Displays the contents of the previous node in the path
        const button = document.getElementById("back")
        button.onclick = () => {
            if (path == "") { ViewBlogs() }
            else{
                DisplayBlogTree(blog, path.substring(0, path.lastIndexOf('/')))
            }
        }
    }

    // Allow the user to select one of the existing blogs to view
    function ViewBlogs(){
        // Clear the existing list
        file_list.innerHTML = ''

        // Display each of the blogs as an option
        blogs.forEach(element => {
            let li = document.createElement('li')
            li.classList.add("link")
            li.innerText = element.name

            li.onclick = () => {
                element.displayBlog()
            }

            file_list.appendChild(li)
        });
    }
</script>